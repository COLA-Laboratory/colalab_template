 % reporttitleblock.sty
% Title block helpers for the technical report template.
%
% Provides:
% - \ReportTitle{...}
% - \ReportSubtitle{...}
% - \ReportAffil{<id>}{<text>}
% - \ReportAuthor{Name}{affil-ids}[roles]{email}
%   roles: equal, corresponding (comma-separated)
% - \ReportClearAffils, \ReportClearAuthors
% - \ReportEqualNote{...}, \ReportCorrespondingLabel{...}
% - \MakeReportTitleBlock
%
% Notes:
% - Affiliation ids should be numeric (1,2,3,...) for sorting.
% - Email is optional: omit the final {email} or pass {}.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{reporttitleblock}[2026/02/09 v0.1 Technical report title block]

\RequirePackage{xparse}
\RequirePackage{xcolor}

% Provide defaults if the main document doesn't define these colors.
\providecolor{headerblue}{RGB}{0,85,150}
\providecolor{natureblue}{RGB}{11,61,145}
\providecolor{titlegray}{RGB}{80,80,80}

\ExplSyntaxOn
\tl_new:N \g_report_title_tl
\tl_new:N \g_report_subtitle_tl
\tl_new:N \g_report_equal_note_tl
\tl_new:N \g_report_corr_label_tl
\seq_new:N \g_report_authors_seq
\seq_new:N \g_report_affil_keys_seq
\prop_new:N \g_report_affils_prop
\bool_new:N \g_report_has_equal_bool
\seq_new:N \g_report_corr_emails_seq
\seq_new:N \g_report_all_emails_seq

\tl_gset:Nn \g_report_equal_note_tl {These~authors~contributed~equally }
\tl_gset:Nn \g_report_corr_label_tl {Corresponding~author }

\NewDocumentCommand{\ReportTitle}{m}{\tl_gset:Nn \g_report_title_tl {#1}}
\NewDocumentCommand{\ReportSubtitle}{m}{\tl_gset:Nn \g_report_subtitle_tl {#1}}
\NewDocumentCommand{\ReportEqualNote}{m}{\tl_gset:Nn \g_report_equal_note_tl {#1}}
\NewDocumentCommand{\ReportCorrespondingLabel}{m}{\tl_gset:Nn \g_report_corr_label_tl {#1}}

\NewDocumentCommand{\ReportClearAuthors}{}{
  \seq_gclear:N \g_report_authors_seq
  \bool_gset_false:N \g_report_has_equal_bool
  \seq_gclear:N \g_report_corr_emails_seq
  \seq_gclear:N \g_report_all_emails_seq
}
\NewDocumentCommand{\ReportClearAffils}{}{
  \seq_gclear:N \g_report_affil_keys_seq
  \prop_gclear:N \g_report_affils_prop
}

\NewDocumentCommand{\ReportAffil}{m m}{
  \prop_gput:Nnn \g_report_affils_prop {#1} {#2}
  \seq_if_in:NnF \g_report_affil_keys_seq {#1}
    { \seq_gput_right:Nn \g_report_affil_keys_seq {#1} }
}

% \ReportAuthor{Name}{affil-ids}[roles]{email}
\NewDocumentCommand{\ReportAuthor}{m m O{} G{}}{
  \seq_gput_right:Nn \g_report_authors_seq { {#1}{#2}{#3}{#4} }
  \clist_if_in:nnT {#3} {equal} { \bool_gset_true:N \g_report_has_equal_bool }
  \tl_if_blank:nF {#4} { \seq_gput_right:Nn \g_report_all_emails_seq {#4} }
  \clist_if_in:nnT {#3} {corresponding} {
    \tl_if_blank:nF {#4} { \seq_gput_right:Nn \g_report_corr_emails_seq {#4} }
  }
}

\cs_new_protected:Npn \report_author_superscript:nn #1#2
{
  \tl_set:Nn \l_tmpa_tl {#1}
  \clist_if_in:nnT {#2} {equal} { \tl_put_right:Nn \l_tmpa_tl { \textdagger } }
  \clist_if_in:nnT {#2} {corresponding} { \tl_put_right:Nn \l_tmpa_tl { * } }
  \tl_use:N \l_tmpa_tl
}

\cs_new_protected:Npn \report_print_author:nnnn #1#2#3#4
{ \textbf{#1}\textsuperscript{\report_author_superscript:nn {#2} {#3}} }

\cs_new_protected:Npn \report_print_authors_line:
{
  \int_zero:N \l_tmpa_int
  \int_set:Nn \l_tmpb_int { \seq_count:N \g_report_authors_seq }
  \seq_map_inline:Nn \g_report_authors_seq
  {
    \int_incr:N \l_tmpa_int
    \report_print_author:nnnn ##1
    \int_compare:nNnT { \l_tmpa_int } < { \l_tmpb_int } { ,\space }
  }
  \par
}

\cs_new_protected:Npn \report_print_affils:
{
  \seq_set_eq:NN \l_tmpa_seq \g_report_affil_keys_seq
  \seq_sort:Nn \l_tmpa_seq
  {
    \int_compare:nNnTF {##1} > {##2}
      { \sort_return_swapped: }
      { \sort_return_same: }
  }
  {\small\color{titlegray}\itshape
    \int_zero:N \l_tmpa_int
    \int_set:Nn \l_tmpb_int { \seq_count:N \l_tmpa_seq }
    \seq_map_inline:Nn \l_tmpa_seq
      {
        \int_incr:N \l_tmpa_int
        \textsuperscript{##1}\prop_item:Nn \g_report_affils_prop {##1}
        \int_compare:nNnT { \l_tmpa_int } < { \l_tmpb_int } { \quad }
      }
    \par
  }
}

\cs_new_protected:Npn \report_mailto:n #1
{
  \cs_if_exist:NTF \href
    { \href{mailto:#1}{\texttt{#1}} }
    { \texttt{#1} }
}

% Print a single "Email: ..." line under affiliations (optional).
% This macro is used by \MakeReportTitleBlock.
\cs_set_protected:Npn \report_print_emails_under_affils:
{
  \seq_if_empty:NF \g_report_all_emails_seq
  {
    \seq_set_eq:NN \l_tmpa_seq \g_report_all_emails_seq
    \seq_remove_duplicates:N \l_tmpa_seq
    {\small\color{titlegray}\itshape
      Email:\space
      \int_zero:N \l_tmpa_int
      \int_set:Nn \l_tmpb_int { \seq_count:N \l_tmpa_seq }
      \seq_map_inline:Nn \l_tmpa_seq
      {
        \int_incr:N \l_tmpa_int
        \report_mailto:n {##1}
        \int_compare:nNnT { \l_tmpa_int } < { \l_tmpb_int } {,~}
      }
      \par
    }
  }
}

% Print a single "Email: ..." line under affiliations (optional).
% This macro is used by \MakeReportTitleBlock.
\cs_set_protected:Npn \report_print_emails_under_affils:
{
  \seq_if_empty:NF \g_report_all_emails_seq
  {
    \seq_set_eq:NN \l_tmpa_seq \g_report_all_emails_seq
    \seq_remove_duplicates:N \l_tmpa_seq
    {\small\color{titlegray}\itshape
      Email:\space
      \int_zero:N \l_tmpa_int
      \int_set:Nn \l_tmpb_int { \seq_count:N \l_tmpa_seq }
      \seq_map_inline:Nn \l_tmpa_seq
      {
        \int_incr:N \l_tmpa_int
        \report_mailto:n {##1}
        \int_compare:nNnT { \l_tmpa_int } < { \l_tmpb_int } {,~}
      }
      \par
    }
  }
}

% A footnote-like line without any numeric mark.
% We implement it by temporarily emptying the mark and using \footnotetext.
\cs_gset_protected:Npn \report_unmarked_footnotetext:n #1
{
  \begingroup
    \makeatletter
    \let\@thefnmark\@empty
    \let\thefootnote\@empty
    \footnotetext{#1}
  \endgroup
}

% Put author notes (equal contribution, corresponding author, emails) into footnotes.
\cs_new_protected:Npn \report_footnote_author_notes:
{
  % All lines below should be unnumbered (no leading 0,1,2,...).
  \bool_if:NT \g_report_has_equal_bool
    { \report_unmarked_footnotetext:n { \textsuperscript{\textdagger}\tl_use:N \g_report_equal_note_tl } }

  \seq_if_empty:NF \g_report_corr_emails_seq
  {
    \seq_set_eq:NN \l_tmpa_seq \g_report_corr_emails_seq
    \seq_remove_duplicates:N \l_tmpa_seq
    \report_unmarked_footnotetext:n { \textsuperscript{*}\tl_use:N \g_report_corr_label_tl }
  }

}

\NewDocumentCommand{\MakeReportTitleBlock}{}{
  \noindent{\color{headerblue!80}\rule{\textwidth}{0.6pt}}\par\vspace{0.8em}
  {\centering
    {\LARGE \bfseries \tl_use:N \g_report_title_tl \par}
  }\par\vspace{0.4em}
  \noindent{\color{headerblue}\rule{\textwidth}{0.6pt}}\par\vspace{0.8em}
  {\centering
    {\large\color{natureblue} \tl_use:N \g_report_subtitle_tl \par}
    \vspace{0.9em}
    {\normalsize
      \report_print_authors_line:
      \vspace{0.4em}
      \report_print_affils:
      \report_print_emails_under_affils:
      \vspace{0.3em}
    }
  }\par\vspace{0.8em}
  \report_footnote_author_notes:
}
\ExplSyntaxOff
